<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="theme-color" content="#a4cfdf">
  
  <title>一个带AI的俄罗斯方块游戏 | Constantin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="来自实验周的锅上周算法实验周，老师给了一堆带AI的游戏题目，本来准备写以前写过的贪吃蛇，但是手慢被抢走了，然后就选择了俄罗斯方块，怎料光写俄罗斯方块这个游戏就很有挑战了/(ㄒoㄒ)/~~，倒是游戏写完后的AI还没怎么费神。">
<meta name="keywords" content="GameAI">
<meta property="og:type" content="article">
<meta property="og:title" content="一个带AI的俄罗斯方块游戏">
<meta property="og:url" content="http://yoursite.com/2018/05/09/TetrisWithAI/index.html">
<meta property="og:site_name" content="Constantin">
<meta property="og:description" content="来自实验周的锅上周算法实验周，老师给了一堆带AI的游戏题目，本来准备写以前写过的贪吃蛇，但是手慢被抢走了，然后就选择了俄罗斯方块，怎料光写俄罗斯方块这个游戏就很有挑战了/(ㄒoㄒ)/~~，倒是游戏写完后的AI还没怎么费神。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/img/Tetris.png">
<meta property="og:image" content="http://yoursite.com/img/line.png">
<meta property="og:image" content="http://yoursite.com/img/tetris-end.png">
<meta property="og:updated_time" content="2018-05-09T08:58:37.136Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一个带AI的俄罗斯方块游戏">
<meta name="twitter:description" content="来自实验周的锅上周算法实验周，老师给了一堆带AI的游戏题目，本来准备写以前写过的贪吃蛇，但是手慢被抢走了，然后就选择了俄罗斯方块，怎料光写俄罗斯方块这个游戏就很有挑战了/(ㄒoㄒ)/~~，倒是游戏写完后的AI还没怎么费神。">
<meta name="twitter:image" content="http://yoursite.com/img/Tetris.png">
  
    <link rel="alternative" href="/atom.xml" title="Constantin" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="/img/head(2).png" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Constantin</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
							<li><a href="https://www.instagram.com/prconstantin/">ins</a></li>
				        
							<li><a href="https://twitter.com/PrConstantine?lang=zh-cn">twitter</a></li>
				        
							<li><a href="http://ingress.constantin.cc">ingress</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/uselessaddress" title="github">github</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
								<a class="mail" target="_blank" href="/" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/GameAI/" style="font-size: 10px;">GameAI</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/react-native/" style="font-size: 10px;">react-native</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/全景/" style="font-size: 10px;">全景</a> <a href="/tags/内网穿透/" style="font-size: 10px;">内网穿透</a> <a href="/tags/实习项目总结/" style="font-size: 20px;">实习项目总结</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a> <a href="/tags/面试题/" style="font-size: 10px;">面试题</a> <a href="/tags/项目总结/" style="font-size: 20px;">项目总结</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://mzi.red">MZI</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://sanmumuzi.github.io">sanmumuzi</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://frankrx41.github.io/">FrankRx41</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://soiomon.github.io/">Solomon</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">NJUPT、前端、Ingress-Enlightened</div>
				</section>
				
			</div>
		</div>
	</header>	
	<div class="hide-left">
	</div>			
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Constantin</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/head(2).png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Constantin</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
					<li><a href="https://www.instagram.com/prconstantin/">ins</a></li>
		        
					<li><a href="https://twitter.com/PrConstantine?lang=zh-cn">twitter</a></li>
		        
					<li><a href="http://ingress.constantin.cc">ingress</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/uselessaddress" title="github">github</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="/" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-TetrisWithAI" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      

<a href="/2018/05/09/TetrisWithAI/" class="article-date">
  	<time datetime="2018-05-09T08:58:37.135Z" itemprop="datePublished">2018-05-09</time>
  	<br/>
    
        <span id="busuanzi_container_page_pv" style="color:DarkGray">
        view <span id="busuanzi_value_page_pv"></span> times 
        </span>
    
</a>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      一个带AI的俄罗斯方块游戏
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GameAI/">GameAI</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">	
      


      <div class="back-top"></div>
	  
		
			<div id="toc" class="toc-article">
			  <strong class="toc-title">文章目录</strong>
			  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#来自实验周的锅"><span class="toc-number">1.</span> <span class="toc-text">来自实验周的锅</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选择与学习"><span class="toc-number">2.</span> <span class="toc-text">选择与学习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#先来看看最后的效果"><span class="toc-number">3.</span> <span class="toc-text">先来看看最后的效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-number">4.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整体结构"><span class="toc-number">5.</span> <span class="toc-text">整体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分步讲解"><span class="toc-number">6.</span> <span class="toc-text">分步讲解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现AI"><span class="toc-number">7.</span> <span class="toc-text">实现AI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到的问题"><span class="toc-number">8.</span> <span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结语："><span class="toc-number">9.</span> <span class="toc-text">结语：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#声明"><span class="toc-number">10.</span> <span class="toc-text">声明:</span></a></li></ol>
			</div>
		
		
        <h2 id="来自实验周的锅"><a href="#来自实验周的锅" class="headerlink" title="来自实验周的锅"></a>来自实验周的锅</h2><p>上周算法实验周，老师给了一堆带AI的游戏题目，本来准备写以前写过的贪吃蛇，但是手慢被抢走了，然后就选择了俄罗斯方块，怎料光写俄罗斯方块这个游戏就很有挑战了/(ㄒoㄒ)/~~，倒是游戏写完后的AI还没怎么费神。<br><a id="more"></a></p>
<hr>
<h2 id="选择与学习"><a href="#选择与学习" class="headerlink" title="选择与学习"></a>选择与学习</h2><p>因为老师并没有限制语言和实现方法，我很开心的选择了用React撸一个网页出来,网页便捷的交互事件和状态更新触发渲染绘图用起来不要太方便，这一套也算是比较熟悉，在寻找相关资料的时候发现了有大佬已经写过一个<a href="https://www.hoyt-tian.com/tag/tetris/" target="_blank" rel="noopener">链接在此</a>,找到大佬的Github，然后开始学习，大佬代码没怎么注释，而且旋转系统也还有BUG，我找到了旋转系统的写法(链接在此)，然后算法是使用遗传算法训练相应权值，且听我一步一步道来。<br>源码地址在此：<a href="https://github.com/uselessaddress/TetrisWithAI" target="_blank" rel="noopener">https://github.com/uselessaddress/TetrisWithAI</a><br>训练的源码：<a href="https://github.com/uselessaddress/TetrisAITraining" target="_blank" rel="noopener">https://github.com/uselessaddress/TetrisAITraining</a></p>
<hr>
<h2 id="先来看看最后的效果"><a href="#先来看看最后的效果" class="headerlink" title="先来看看最后的效果"></a>先来看看最后的效果</h2><p><img src="/img/Tetris.png" alt="Tetris"></p>
<hr>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li>实现一个经典版本的俄罗斯方块游戏</li>
<li>游戏包含最经典的Tetris形状（7种），同时支持方便的扩展其他形状，Tetris可以移动、变形</li>
<li>可以切换游戏模式，由人控制或者AI控制，人操控时，每隔一定时间若无输入，Tetris自然落下一格;AI控制时，需要模拟人类的操作过程</li>
</ul>
<hr>
<h2 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h2><ol>
<li>视图部分：由小到大，Tile(每个小方块)-&gt;Tetris(由几个小块组成的一种方块)-&gt;预览画板-&gt;游戏画板(一个10*20的标准游戏区域)，画图部分使用H5的Cancas</li>
<li>控制部分：重置按钮，用于刷新重置整个游戏；暂停按钮，用于暂停游戏；AI控制按钮：点击可以切换是人工控制还是AI控制，默认是人工控制</li>
<li>视图绑定的数据：画板初始化为值为null二维矩阵，Tetris是由二维矩阵保存的一个俄罗斯方块，Tile只需保存当前块颜色</li>
</ol>
<hr>
<h2 id="分步讲解"><a href="#分步讲解" class="headerlink" title="分步讲解"></a>分步讲解</h2><ol>
<li>视图：<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每个小方块</span></span><br><span class="line">class Tile&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">get</span>(<span class="built_in">color</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!tiles[<span class="built_in">color</span>])&#123;</span><br><span class="line">            tiles[<span class="built_in">color</span>] = <span class="keyword">new</span> Tile(<span class="built_in">color</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tiles[<span class="built_in">color</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    constructor(<span class="built_in">color</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">color</span> = <span class="built_in">color</span> || ColorPicker.<span class="built_in">random</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>可以看到这里只用保存每个方块的颜色即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方块对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tetris</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(matrix,color) &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">data</span> = Tetris.clone(matrix);</span><br><span class="line">        <span class="keyword">this</span>.color = color || ColorPicker.random();</span><br><span class="line">        <span class="keyword">this</span>.row = <span class="keyword">this</span>.col = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    ..............</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取指定的形状</span></span><br><span class="line">    static shape(i)&#123;</span><br><span class="line">        <span class="keyword">return</span> shapes[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取形状的总数</span></span><br><span class="line">    static shapeCount()&#123;</span><br><span class="line">        <span class="keyword">return</span> shapes.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// * 设置位置</span></span><br><span class="line">    setPos(row,col)&#123;</span><br><span class="line">        <span class="keyword">this</span>.row = row;</span><br><span class="line">        <span class="keyword">this</span>.col = col;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取传入的行列值对应位置的tile</span></span><br><span class="line">    getTile(row,col)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.<span class="keyword">data</span>[row][col]!==<span class="string">'0'</span>)</span><br><span class="line">            <span class="keyword">return</span> Tile.<span class="keyword">get</span>(<span class="keyword">this</span>.color);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// * 当前宽度是传入方块的高度</span></span><br><span class="line">    width()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">data</span>[<span class="number">0</span>].length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// * 当前高度是传入方块的宽度</span></span><br><span class="line">    height()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">data</span>.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//顺时针旋转</span></span><br><span class="line">    clockwise()&#123;</span><br><span class="line">        let w = <span class="keyword">this</span>.width(),h = <span class="keyword">this</span>.height();</span><br><span class="line">        <span class="comment">//w是之前的列数，h是之前的行数</span></span><br><span class="line">        <span class="comment">//用之前的列数对应当前的行数</span></span><br><span class="line">        <span class="comment">//用之前的行数对应到当前的列数</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>((w===<span class="number">1</span>&amp;&amp;h===<span class="number">4</span>)||(w===<span class="number">4</span>&amp;&amp;h===<span class="number">1</span>))&#123;</span><br><span class="line">            let preData = buildMatrix(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">            let nextData = buildMatrix(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">if</span>(w===<span class="number">4</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(let i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(let j=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(i===<span class="number">1</span>)&#123;</span><br><span class="line">                            </span><br><span class="line">                            preData[<span class="number">1</span>][j] = <span class="keyword">this</span>.<span class="keyword">data</span>[<span class="number">0</span>][j];</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            preData[i][j] = <span class="string">'0'</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; <span class="number">4</span>;row++)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; <span class="number">4</span>;col++)&#123;</span><br><span class="line">                        nextData[col][<span class="number">3</span>-row] = preData[row][col]</span><br><span class="line">                        <span class="comment">// console.log(col,3-row)</span></span><br><span class="line">                         <span class="comment">/*顺时针旋转规则：</span></span><br><span class="line"><span class="comment">                            当前的行数等于之前的列数</span></span><br><span class="line"><span class="comment">                            当前的列等于之前的总行数-之前的列数</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">                <span class="keyword">return</span> nextData;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(w===<span class="number">1</span>)&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span>(let i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">                   <span class="keyword">for</span>(let j=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">                       <span class="keyword">if</span>(j === <span class="number">2</span>)&#123;</span><br><span class="line">                            preData[i][<span class="number">2</span>] = <span class="keyword">this</span>.<span class="keyword">data</span>[i][<span class="number">0</span>]</span><br><span class="line">                       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            preData[i][j] = <span class="string">'0'</span></span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// console.log(preData)</span></span><br><span class="line">                <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; <span class="number">4</span>;row++)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; <span class="number">4</span>;col++)&#123; </span><br><span class="line">                        nextData[col][<span class="number">3</span>-row] = preData[row][col]</span><br><span class="line">                         <span class="comment">/*顺时针旋转规则：</span></span><br><span class="line"><span class="comment">                            当前的行数等于之前的列数</span></span><br><span class="line"><span class="comment">                            当前的列等于之前的总行数-之前的列数</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// console.log(nextData)</span></span><br><span class="line">                <span class="keyword">return</span> nextData;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        let nextData = buildMatrix(w,h);</span><br><span class="line">        <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; h;row++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; w;col++)&#123;</span><br><span class="line">                nextData[col][h<span class="number">-1</span>-row] = <span class="keyword">this</span>.<span class="keyword">data</span>[row][col]</span><br><span class="line">                 <span class="comment">/*顺时针旋转规则：</span></span><br><span class="line"><span class="comment">                    当前的行数等于之前的列数</span></span><br><span class="line"><span class="comment">                    当前的列等于之前的总行数-之前的列数</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//逆时针旋转规则</span></span><br><span class="line">    anticlockwise()&#123;</span><br><span class="line">        let w = <span class="keyword">this</span>.width(),h = <span class="keyword">this</span>.height();</span><br><span class="line">        let nextData = buildMatrix(w,h)</span><br><span class="line">        <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; h;row++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; w;col++)&#123;</span><br><span class="line">                nextData[w<span class="number">-1</span>-col][row] = <span class="keyword">this</span>.<span class="keyword">data</span>[row][col]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//旋转</span></span><br><span class="line">    turn(clockwise,rows,cols)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.col + <span class="keyword">this</span>.height() &gt; cols || <span class="keyword">this</span>.row + <span class="keyword">this</span>.width() &gt; rows)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        </span><br><span class="line">        let nextData = clockwise?<span class="keyword">this</span>.clockwise():<span class="keyword">this</span>.anticlockwise()</span><br><span class="line">        let w = <span class="keyword">this</span>.width(),h = <span class="keyword">this</span>.height()</span><br><span class="line"></span><br><span class="line">        let result = &#123;</span><br><span class="line">            before : <span class="keyword">this</span>.<span class="keyword">data</span>,</span><br><span class="line">            after:nextData</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">data</span> = nextData;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是Tetris的关键部分，可以看到对长条的旋转进行了特殊处理，先将其放到为4*4的矩阵里，然后再旋转，就像下图这样<br><img src="/img/line.png" alt="line">，在Tetris里有两个地方需要理解，第一个是相对位置，Tetris相对于游戏画板左上角距离的行列值，这个位置值用于在游戏画板中绘制当前Tetris，还有就是旋转操作，顺时针旋转规则：当前的行数等于之前的列数， 当前的列等于之前的总行数-之前的行数；逆时针旋转规则：当前的列数等于之前的行数，当前的行数等于之前的总列数-之前的列数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//画布区域</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span> <span class="title">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            <span class="keyword">data</span>:props.<span class="keyword">data</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    componentDidUpdate() &#123;</span><br><span class="line">        </span><br><span class="line">        let context = <span class="keyword">this</span>.refs.canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">        context.clearRect(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.refs.canvas.width,<span class="keyword">this</span>.refs.canvas.height)</span><br><span class="line">        let tile = <span class="literal">null</span>;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.<span class="keyword">data</span> &amp;&amp; <span class="keyword">this</span>.state.<span class="keyword">data</span>.length &amp;&amp; <span class="keyword">this</span>.state.<span class="keyword">data</span>[<span class="number">0</span>].length)&#123;</span><br><span class="line">            <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; <span class="keyword">this</span>.state.<span class="keyword">data</span>.length<span class="number">-2</span>;row++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; <span class="keyword">this</span>.state.<span class="keyword">data</span>[row].length;col++)&#123;</span><br><span class="line">                    tile = <span class="keyword">this</span>.state.<span class="keyword">data</span>[row][col];</span><br><span class="line">                    <span class="keyword">if</span>(tile == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    context.fillStyle = tile.color;</span><br><span class="line">                    context.fillRect(</span><br><span class="line">                        (col<span class="number">-2</span>) * TileWidth,</span><br><span class="line">                        row * TileHeight,</span><br><span class="line">                        TileWidth-TilePadding,</span><br><span class="line">                        TileHeight-TilePadding</span><br><span class="line">                    )</span><br><span class="line">                    <span class="comment">//绘制图形的四个参数依次为：相对右上角的x坐标，相对左上角的x坐标，宽度，高度</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ? 还有疑问</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.active)&#123;</span><br><span class="line">            context.fillStyle = ColorPicker.activeColor();</span><br><span class="line">            <span class="keyword">for</span>(let row = <span class="number">0</span>;row &lt; <span class="keyword">this</span>.state.active.height();row++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(let col = <span class="number">0</span>;col &lt; <span class="keyword">this</span>.state.active.width();col++)&#123;</span><br><span class="line">                    tile = <span class="keyword">this</span>.state.active.getTile(row,col);</span><br><span class="line">                    <span class="keyword">if</span>(tile)&#123;</span><br><span class="line">                        context.fillStyle = tile.color;</span><br><span class="line">                        context.fillRect(</span><br><span class="line">                            (<span class="keyword">this</span>.state.active.col<span class="number">-2</span>+col)*TileWidth,</span><br><span class="line">                            (<span class="keyword">this</span>.state.active.row+row)*TileHeight,</span><br><span class="line">                            TileWidth - TilePadding,</span><br><span class="line">                            TileHeight - TilePadding</span><br><span class="line">                        )</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="comment">//创建canvans元素</span></span><br><span class="line">        <span class="keyword">return</span> React.createElement(<span class="string">'canvas'</span>,&#123;</span><br><span class="line">            ref : <span class="string">'canvas'</span>,</span><br><span class="line">            width:(<span class="keyword">this</span>.props.cols<span class="number">-4</span>) * TileWidth,</span><br><span class="line">            height: (<span class="keyword">this</span>.props.rows<span class="number">-2</span>) * TileHeight</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是绘制游戏画布的过程。<br>接下来是控制部分</p>
<ol start="2">
<li>游戏控制部分<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建方块</span></span><br><span class="line">  dropNew = ()=&gt;&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span>.status &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">      console.log(<span class="string">"new"</span>)</span><br><span class="line">      let next = <span class="keyword">this</span>.setPreviewPosition(Tetris.random());</span><br><span class="line">      let active = <span class="keyword">this</span>.state.next?<span class="keyword">this</span>.setNewTetrisPosition(<span class="keyword">this</span>.state.next):<span class="keyword">this</span>.setNewTetrisPosition(Tetris.random());</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          active:active,</span><br><span class="line">          next:next</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">this</span>.refs.preview.setState(&#123;</span><br><span class="line">          active:next</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">this</span>.refs.main.setState(&#123;</span><br><span class="line">          <span class="keyword">data</span>:<span class="keyword">this</span>.state.<span class="keyword">data</span>,</span><br><span class="line">          active: active</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span>.timer_input == <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="keyword">this</span>.timer_input = window.setTimeout(<span class="keyword">this</span>.autoDrop.bind(<span class="keyword">this</span>),<span class="keyword">this</span>.interval_input)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>新掉落方块，更新当前active砖块，this.state.data是保存残留方块</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按下键触发的相应事件</span></span><br><span class="line">    doAction=(keyCode)=&gt;&#123;</span><br><span class="line">        <span class="comment">// console.log(this.state.active)</span></span><br><span class="line">        let r = <span class="literal">null</span></span><br><span class="line">        switch(keyCode)&#123;</span><br><span class="line">            case <span class="number">0x25</span>: <span class="comment">//left</span></span><br><span class="line">                <span class="keyword">this</span>.moveActiveLeft();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="number">0x27</span>: <span class="comment">//right</span></span><br><span class="line">                <span class="keyword">this</span>.moveActiveRight();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="number">0x20</span>: <span class="comment">//speed up</span></span><br><span class="line">                r = <span class="keyword">this</span>.moveActiveDown();</span><br><span class="line">                <span class="keyword">if</span>(r == <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.gameover()  </span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(r === <span class="literal">false</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.merge(<span class="keyword">this</span>.state.active);</span><br><span class="line">                    <span class="keyword">this</span>.state.score += <span class="keyword">this</span>.clear();</span><br><span class="line">                    <span class="keyword">this</span>.state.total ++;</span><br><span class="line">                    <span class="keyword">this</span>.dropNew()</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(r &amp;&amp; <span class="keyword">this</span>.useAI)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                        <span class="keyword">data</span>:<span class="keyword">this</span>.state.<span class="keyword">data</span>,</span><br><span class="line">                        active: <span class="keyword">this</span>.state.active,</span><br><span class="line">                        total: <span class="keyword">this</span>.state.total,</span><br><span class="line">                        score: <span class="keyword">this</span>.state.score</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">this</span>.refs.main.setState(&#123;</span><br><span class="line">                        <span class="keyword">data</span>: <span class="keyword">this</span>.state.<span class="keyword">data</span>,</span><br><span class="line">                        active: <span class="keyword">this</span>.state.active</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">this</span>.refs.preview.setState(&#123;</span><br><span class="line">                        active: <span class="keyword">this</span>.state.next</span><br><span class="line">                    &#125;);</span><br><span class="line">                    window.setTimeout( <span class="keyword">this</span>.aiStep.bind(<span class="keyword">this</span>), <span class="keyword">this</span>.interval_ai);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="number">0x26</span>: <span class="comment">//up anticlockwise</span></span><br><span class="line">                r = <span class="keyword">this</span>.state.active.turn(<span class="literal">false</span>,<span class="keyword">this</span>.rows,<span class="keyword">this</span>.cols);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(r &amp;&amp; Game.testCollsion(<span class="keyword">this</span>.state.<span class="keyword">data</span>, <span class="keyword">this</span>.state.active))&#123;</span><br><span class="line">                    <span class="keyword">this</span>.state.active.turn(<span class="literal">true</span>, <span class="keyword">this</span>.rows, <span class="keyword">this</span>.cols);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            case <span class="number">0x28</span>: <span class="comment">//down clockwise</span></span><br><span class="line">                r = <span class="keyword">this</span>.state.active.turn(<span class="literal">true</span>, <span class="keyword">this</span>.rows, <span class="keyword">this</span>.cols);</span><br><span class="line">                <span class="keyword">if</span>(r &amp;&amp; Game.testCollsion(<span class="keyword">this</span>.state.<span class="keyword">data</span>, <span class="keyword">this</span>.state.active))&#123;</span><br><span class="line">                    <span class="keyword">this</span>.state.active.turn(<span class="literal">false</span>, <span class="keyword">this</span>.rows, <span class="keyword">this</span>.cols);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            <span class="keyword">data</span>:<span class="keyword">this</span>.state.<span class="keyword">data</span>,</span><br><span class="line">            active:<span class="keyword">this</span>.state.active,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">this</span>.refs.main.setState(&#123;</span><br><span class="line">            <span class="keyword">data</span>:<span class="keyword">this</span>.state.<span class="keyword">data</span>,</span><br><span class="line">            active:<span class="keyword">this</span>.state.active</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向下移动，能下落返回true，不能返回false，结束游戏返回null</span></span><br><span class="line"> moveActiveDown = ()=&gt;&#123;</span><br><span class="line">        let bottom = <span class="keyword">this</span>.state.active.row + <span class="keyword">this</span>.state.active.height();</span><br><span class="line">        <span class="keyword">if</span>(bottom &lt;= <span class="keyword">this</span>.rows)&#123;</span><br><span class="line">            <span class="keyword">this</span>.state.active.row++</span><br><span class="line">            <span class="keyword">if</span>(Game.testCollsion(<span class="keyword">this</span>.state.<span class="keyword">data</span>,<span class="keyword">this</span>.state.active))&#123;</span><br><span class="line">                <span class="keyword">this</span>.state.active.row --;</span><br><span class="line">                <span class="keyword">if</span>(Game.testCollsion(<span class="keyword">this</span>.state.<span class="keyword">data</span>,<span class="keyword">this</span>.state.active))&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span> </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//碰撞测试</span><br><span class="line">   static testCollsion(<span class="built_in">matrix</span>,tetris)&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="built_in">let</span> <span class="built_in">row</span> = <span class="number">0</span>;<span class="built_in">row</span> &lt; tetris.<span class="built_in">height</span>(); <span class="built_in">row</span>++)&#123;</span><br><span class="line">           <span class="keyword">for</span>(<span class="built_in">let</span> <span class="built_in">col</span> = <span class="number">0</span>;<span class="built_in">col</span> &lt; tetris.<span class="built_in">width</span>();<span class="built_in">col</span>++)&#123;</span><br><span class="line">               <span class="keyword">if</span>((tetris.<span class="built_in">row</span> + <span class="built_in">row</span> &gt;= <span class="built_in">matrix</span>.<span class="built_in">length</span>)</span><br><span class="line">                   ||(tetris.<span class="built_in">col</span> + <span class="built_in">col</span> &gt;= <span class="built_in">matrix</span>[<span class="number">0</span>].<span class="built_in">length</span>)</span><br><span class="line">                   ||(<span class="built_in">matrix</span>[tetris.<span class="built_in">row</span> + <span class="built_in">row</span>][tetris.<span class="built_in">col</span> + <span class="built_in">col</span>] !== null</span><br><span class="line">                   &amp;&amp; tetris.getTile(<span class="built_in">row</span>,<span class="built_in">col</span>) !== null</span><br><span class="line">                   ))&#123; </span><br><span class="line">                       </span><br><span class="line">                       <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>执行流程</p>
<ul>
<li>系统初始化，生成游戏Grid、预览Grid，监听键盘事件</li>
<li>生成2个随机Tetris，作为初始Tetris，一个是当前活动可控的Tetris，另一个是作为下一个即将下落的Tetris</li>
<li>更新Tetris坐标，进行碰撞计算</li>
<li>活动Tetris落到底部后，将下一个即将落下的Tetris作为活动Tetris，并重新生成下一个Tetris</li>
<li><p>AI的执行流程也是一样的，只是等待的不是玩家输入，而是AI给出的按键。</p>
<p> 到此整个游戏的核心部分基本都列举出来，能够愉快的玩上一会，接下来就是想办法让计算机帮你玩啦</p>
</li>
</ul>
<hr>
<h2 id="实现AI"><a href="#实现AI" class="headerlink" title="实现AI"></a>实现AI</h2><p>此处选自大佬文章：<a href="https://www.hoyt-tian.com/zhuan-ti-e-luo-si-fang-kuai-de-reactshi-xian-san-aisuan-fa-ji-qi-shi-xian/" target="_blank" rel="noopener">https://www.hoyt-tian.com/zhuan-ti-e-luo-si-fang-kuai-de-reactshi-xian-san-aisuan-fa-ji-qi-shi-xian/</a></p>
<ul>
<li>整体思路<br>由于方块的每次可能的着陆状态是有限的，因此枚举所有的着陆可能，并结合当前游戏区域的状态，给每一种可能性予以评分，最后选择得分最高的着陆点，然后生成一条从起落点到终点的路径，就是一个砖块的解。重复这个步骤，就是一个游戏ai。</li>
<li>状态分析，给定一个当前的游戏数据矩阵和活动砖块的着陆点，分析这种结果的好坏，已知活动砖块的起始状态和终止状态，给出一个状态变化序列描述这个过程</li>
<li>现有分析指标：游戏区域残留的砖块越少越安全，如果一个砖块下落，可以消除某几行，那么优先考虑这个着陆点，尽量不要让砖块落下后导致出现空洞，砖块最好分布的比较均匀，不要一些地方对了很高、一些地方很低，这些经验可以转化成量化手段，LeeYiyuan在自己的AI实现中提出了是个指标来评价一个着陆状态。原文地址见：<a href="http://codemyroad.wordpress.com/2013/04/14/tetris-ai-the-near-perfect-player/" target="_blank" rel="noopener">http://codemyroad.wordpress.com/2013/04/14/tetris-ai-the-near-perfect-player/ </a>（需要翻墙）。这四个指标分别是：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">消除行数，新砖块下落后能消除多少行</span><br><span class="line">空洞数，新砖块下落后，当前局势有多少个空洞</span><br><span class="line">井的数量，新砖块下落后，当前局势井的数量</span><br><span class="line">平整度，新砖块下落后，各列之间的高度差绝对值之和</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>还有一些更为复杂的评价体系，会将砖块的旋转、水平、垂直方向上的移动都考虑进去。<br>本文的评价模型:<br>在综合考虑了多种指标体系之后，我采用了一个仿照LeeYiyuan体系的指标，唯一的不同之处是，LeeYiyuan考虑的井这种特殊形状，我放弃了考虑井，取而代之，引入一个新指标：平均高度。因此，本文使用的完整评价指标为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">消除行数，新砖块下落后能消除多少行</span><br><span class="line">平均高度，新砖块下落后，当前局势的平均高度（刨去将被消除的行）</span><br><span class="line">空洞数，新砖块下落后，当前局势有多少个空洞（刨去将被消除的行）</span><br><span class="line">平整度，新砖块下落后，各列之间的高度差绝对值之和（刨去将被消除的行）</span><br></pre></td></tr></table></figure></p>
<p>虽然只有4个指标，但已经足以量化当前局势的状态。通过平均高度和平整度两个指标，可以激励ai将砖块均匀的分布在游戏区域；通过消除行数，可以激励ai尽可能寻找机会消除砖块；通过平均高度、平整度和空洞度，可以激励ai在压制高度的同时，尽量避免造成空洞。</p>
<ul>
<li><p>指标权重<br>光有这几个指标还不行，这些指标要能组合到一起起作用，还需要有合适的权重系数。指标的选取可以通过阅读文献来获得，但具体的加权系数，就要靠自己去尝试得出了，除非直接使用别人的指标/评价模型和评价方式。<br>那么如何得知这些指标各自的有效权重呢？通过非常经典的遗传算法，可以帮助我们找出各个指标适合的权重系数。</p>
</li>
<li><p>遗传算法<br>遗传算法模拟了自然界生物演化的过程，通过不断筛选出适应性更高的个体，并使它们互相结合，甚至引入少量的突变个体，经过几代的演化之后，就能够得出一些近似的最优解。</p>
</li>
</ul>
<p>具体到俄罗斯方块这个项目，遗传算法的应用如下：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>首先生成一批种子权重值，每一项权重的权重值x介于(-val, val)之间，val可以取<span class="number">0.5</span>或者<span class="number">1</span>，初始种子的适应性(fitness)都可以置为Number.NEGATIVE_INFINITY</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> ai逐一使用这些种子包含的权重系数，去控制游戏，将经历的活动砖块数直接作为适应性的结果</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 当所有种子都计算出对应的适应性值时，对种子集按照适应性结果进行排序，按照降序排列，种群前<span class="number">60</span>%的种子保留到下一轮演化，其余的淘汰</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 剩下的<span class="number">60</span>%的候选种子进行杂交，并伴随一定概率的突变，得到一个新种群</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 重复<span class="number">2</span>～<span class="number">4</span>的步骤，直至候选种群小于某个阈值</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>路径算法<br>在已知了活动砖块的起始状态和终止状态时，砖块的路径就比较容易得到了。<br>首先将砖块旋转到终止状态，然后进行水平方向的移动，最后进行垂直移动，即可到达最终态。而这个操作过程形成的队列，就是需要的结果。</p>
</li>
<li><p>可能有人有疑问，有的时候，还会出现移动到特定位置后的旋转、变形或者水平移动的情况，然后再进行移动。的确，人类在玩俄罗斯方块的时候，时常出现这种情况，来填补由于操作失误或者其他原因导致的部分砖块悬挂，形成的侧边空洞。但为什么这里没有考虑呢？一，是为了简化问题，与此同时，本身的评价模型中，就考虑了尽量避免这种情况。因为模型的平整性、平均高度两个指标，已经要求ai在考虑时，不要出现某个砖块悬空的情况。实际实践时，也发现ai并不会作出侧边空洞，能够存活很久。</p>
</li>
</ul>
<p>至此，俄罗斯方块的AI实现主要内容全部介绍完毕，接下来我对代码做一些简单讲解：</p>
<p>枚举状态部分代码：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">//遍历所有可能性</span><br><span class="line">   think(game)&#123; </span><br><span class="line">       <span class="built_in">let</span> tetris = game.state.active;</span><br><span class="line">       <span class="built_in">let</span> <span class="built_in">origin</span> = &#123;</span><br><span class="line">           <span class="built_in">row</span>: tetris.<span class="built_in">row</span>,</span><br><span class="line">           <span class="built_in">col</span>: tetris.<span class="built_in">col</span>,</span><br><span class="line">           <span class="built_in">matrix</span>: buildMainMatrix(game.rows, game.cols, (<span class="built_in">row</span>, <span class="built_in">col</span>)=&gt;&#123;</span><br><span class="line">               <span class="built_in">return</span> game.state.data[<span class="built_in">row</span>][<span class="built_in">col</span>];</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">let</span> result = [];</span><br><span class="line">       <span class="keyword">for</span>(<span class="built_in">let</span> i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++)&#123;</span><br><span class="line">           <span class="keyword">do</span>&#123;</span><br><span class="line">               <span class="keyword">while</span>(game.moveActiveDown())&#123;</span><br><span class="line">                   ;</span><br><span class="line">               &#125;</span><br><span class="line">               game.merge(tetris);</span><br><span class="line">               <span class="built_in">let</span> state = AI.state(game.state.data, game);</span><br><span class="line">               result.<span class="built_in">push</span>(&#123;</span><br><span class="line">                   state: state,</span><br><span class="line">                   turn: i,</span><br><span class="line">                   <span class="built_in">row</span>:tetris.<span class="built_in">row</span>,</span><br><span class="line">                   <span class="built_in">col</span>:tetris.<span class="built_in">col</span></span><br><span class="line">               &#125;);</span><br><span class="line">               </span><br><span class="line">               </span><br><span class="line">               tetris.setPos(<span class="built_in">origin</span>.<span class="built_in">row</span>, tetris.<span class="built_in">col</span>);                </span><br><span class="line">               game.state.data = buildMainMatrix(game.rows, game.cols, (i, j)=&gt;&#123;</span><br><span class="line">                   <span class="built_in">return</span> <span class="built_in">origin</span>.<span class="built_in">matrix</span>[i][j];</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">           &#125;<span class="keyword">while</span>(game.moveActiveLeft());</span><br><span class="line"></span><br><span class="line">           tetris.setPos(<span class="built_in">origin</span>.<span class="built_in">row</span>, <span class="built_in">origin</span>.<span class="built_in">col</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">while</span>(game.moveActiveRight())&#123;</span><br><span class="line">               <span class="keyword">while</span>(game.moveActiveDown())&#123;</span><br><span class="line">                   ;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               game.merge(tetris);</span><br><span class="line">               <span class="built_in">let</span> state = AI.state(game.state.data, game);</span><br><span class="line">               result.<span class="built_in">push</span>(&#123;</span><br><span class="line">                   state: state,</span><br><span class="line">                   turn: i,</span><br><span class="line">                   <span class="built_in">row</span>:tetris.<span class="built_in">row</span>,</span><br><span class="line">                   <span class="built_in">col</span>:tetris.<span class="built_in">col</span>                   </span><br><span class="line">               &#125;);</span><br><span class="line">               </span><br><span class="line">               </span><br><span class="line">               tetris.setPos(<span class="built_in">origin</span>.<span class="built_in">row</span>, tetris.<span class="built_in">col</span>);                </span><br><span class="line">               game.state.data = buildMainMatrix(game.rows, game.cols, (i, j)=&gt;&#123;</span><br><span class="line">                   <span class="built_in">return</span> <span class="built_in">origin</span>.<span class="built_in">matrix</span>[i][j];</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           tetris.setPos(<span class="built_in">origin</span>.<span class="built_in">row</span>, <span class="built_in">origin</span>.<span class="built_in">col</span>); </span><br><span class="line">           tetris.turn(<span class="literal">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       tetris.setPos(<span class="built_in">origin</span>.<span class="built_in">row</span>, <span class="built_in">origin</span>.<span class="built_in">col</span>);</span><br><span class="line">       game.state.data = <span class="built_in">origin</span>.<span class="built_in">matrix</span>;</span><br><span class="line">       <span class="built_in">return</span> this.actions(result, tetris, game);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到具体遍历流程，首先保存好当前所有的位置信息，然后第一个do-while是向左移动一次，再向下落到不能动，然后计算四种分析指标，保存为一个结果，然后复位重复，第二个while循环向右移动后再向下落至不能移动，计算状态保存为一个结果，最<br>后旋转，再重复，旋转，再重复…</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//获得结果</span><br><span class="line"> actions(result, tetris, game)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result.<span class="built_in">length</span>&lt;=<span class="number">0</span>) <span class="built_in">return</span> [];</span><br><span class="line"></span><br><span class="line">        result.forEach((item)=&gt;&#123;</span><br><span class="line">            item.score = AI.caculate(item.state, game.ai);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        result.<span class="built_in">sort</span>((a,b)=&gt;&#123; <span class="built_in">return</span> b.score - a.score; &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">let</span> target = result[<span class="number">0</span>];</span><br><span class="line">        // console.<span class="built_in">log</span>(result)</span><br><span class="line">        <span class="built_in">let</span> steps = [];</span><br><span class="line">        switch(target.turn)&#123;</span><br><span class="line">            case <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">break</span>;</span><br><span class="line">            case <span class="number">1</span>:</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x28</span>,desc:<span class="string">"TR"</span>&#125;);</span><br><span class="line">                <span class="built_in">break</span>;</span><br><span class="line">            case <span class="number">2</span>:</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x28</span>,desc:<span class="string">"TR"</span>&#125;);</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x28</span>,desc:<span class="string">"TR"</span>&#125;);</span><br><span class="line">                <span class="built_in">break</span>;</span><br><span class="line">            case <span class="number">3</span>:</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x26</span>,desc:<span class="string">"TL"</span>&#125;);</span><br><span class="line">                <span class="built_in">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tetris.<span class="built_in">col</span> &lt; target.<span class="built_in">col</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">let</span> i=tetris.<span class="built_in">col</span>; i&lt;target.<span class="built_in">col</span>; i++)&#123;</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x27</span>,desc:<span class="string">"MR"</span>&#125;);                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(tetris.<span class="built_in">col</span> &gt; target.<span class="built_in">col</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">let</span> i=target.<span class="built_in">col</span>; i&lt;tetris.<span class="built_in">col</span>; i++)&#123;</span><br><span class="line">                steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x25</span>,desc:<span class="string">"ML"</span>&#125;);                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">let</span> i=tetris.<span class="built_in">row</span>; i&lt;target.<span class="built_in">row</span>; i++)&#123;</span><br><span class="line">            steps.<span class="built_in">push</span>(&#123;code:<span class="number">0x20</span>,desc:<span class="string">"MD"</span>&#125;);            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> steps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static caculate(state, ai)&#123;</span><br><span class="line">        <span class="built_in">return</span> state.clear * ai.alpha + state.avgh * ai.<span class="built_in">beta</span> + state.hc * ai.gama + ai.<span class="built_in">delta</span> * state.<span class="built_in">delta</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里是用计算得到的各项指标和各自权值进行计算，将结果从大到小排序，取计算的最大值的位置的作为本次砖块最后的落点，然后生成移动路径数组，返回给控制部分控制移动。</p>
<p>下面是遗传算法部分代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//杂交</span></span><br><span class="line">   <span class="keyword">static</span> crossOver(seed1,seed2)&#123;</span><br><span class="line">       <span class="keyword">let</span> a1 = seed1.fitness / (seed1.fitness + seed2.fitness);<span class="comment">//计算seed1的杂交权重</span></span><br><span class="line">       <span class="keyword">let</span> a2 = seed2.fitness / (seed1.fitness + seed2.fitness);<span class="comment">//计算seed2的杂交权重</span></span><br><span class="line">       <span class="keyword">let</span> newSeed = &#123;</span><br><span class="line">           alpha : a1 * seed1.alpha + a2 * seed2.alpha,</span><br><span class="line">           beta: a1 * seed1.beta + a2 * seed2.beta,</span><br><span class="line">           gama: a1 * seed1.gama + a2 * seed2.gama,</span><br><span class="line">           delta:a1 * seed1.delta + a2 * seed2.delta</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> newSeed;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//突变</span></span><br><span class="line">   multate(seed)&#123;</span><br><span class="line">       <span class="keyword">let</span> d = <span class="built_in">Math</span>.random() - <span class="number">0.5</span>;</span><br><span class="line">       <span class="keyword">let</span> r = <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.random()*<span class="number">4</span>)</span><br><span class="line">       <span class="comment">//随机选择一项进行突变</span></span><br><span class="line">       <span class="keyword">switch</span>(r)&#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">               seed.alpha += d;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               seed.beta += d;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">               seed.gama += d;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">               seed.delta += d;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> seed;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//进化</span></span><br><span class="line">   evolution()&#123;</span><br><span class="line">       <span class="comment">//按照适应值大小从大到小对seed进行排序</span></span><br><span class="line">       <span class="keyword">this</span>.seeds.sort(<span class="function">(<span class="params">a,b</span>)=&gt;</span>&#123;<span class="keyword">return</span> b.fitness - a.fitness;&#125;)</span><br><span class="line"></span><br><span class="line">       <span class="comment">//保存最大项</span></span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.state.max.fitness&lt;<span class="keyword">this</span>.seeds[<span class="number">0</span>].fitness)&#123;</span><br><span class="line">           <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">               max:<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.seeds[<span class="number">0</span>]))</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//取前60%的个体</span></span><br><span class="line">       <span class="keyword">let</span> capacity = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.seeds.length*<span class="number">0.6</span>)</span><br><span class="line">       <span class="keyword">this</span>.seeds.length = capacity;</span><br><span class="line">       <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">           capacity:capacity</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">if</span>(capacity&lt;<span class="number">3</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="keyword">this</span>.seeds.length<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">           <span class="keyword">let</span> x = <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.random()/<span class="number">10</span>*<span class="keyword">this</span>.seeds.length)</span><br><span class="line">           <span class="comment">//取前10分之1</span></span><br><span class="line">           <span class="keyword">this</span>.seeds[i] = GA.crossOver(<span class="keyword">this</span>.seeds[i],<span class="keyword">this</span>.seeds[x]);</span><br><span class="line">           <span class="comment">//随机突变</span></span><br><span class="line">           <span class="keyword">if</span>(<span class="built_in">Math</span>.random()&lt;<span class="number">0.05</span>)&#123;</span><br><span class="line">               <span class="keyword">this</span>.multate(<span class="keyword">this</span>.seeds[i])</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里分别是杂交，突变，进化的代码，首先进化就是先按照适应值从大到小排序，选择前60%的个体保留，进行杂交，杂交就是所有剩下的个体和前10%的个体生成一个新的个体，新的个体的各项指标是根据原有两个个体的杂交权重计算得出，最后是突变，就是随机选择5%的个体，将其随机一项指标加上一个随机值，是不是相当有意思，利用计算的算力，模拟生物种群的进化过程，反正是我觉得相当奇妙了！<br>最后把训练出来的最优值放到AI游戏程序里，这样一个带AI的俄罗斯方块游戏就完成啦！</p>
<hr>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>主要的问题是出在修改旋转系统的地方，遇到了越界的情况，长条型的砖块腾空，发现是长条型的方块的旋转后变为了4*4的方形块从而造成底部有空余，而空余部分也算在砖块整体，导致提前触底碰撞，所以出现砖块腾空。后来想出来的解决方法是采用增加边界法，在底部和两侧都多加了两层，成功解决了这个问题。</p>
<hr>
<h2 id="结语："><a href="#结语：" class="headerlink" title="结语："></a>结语：</h2><p>正如之前大佬在AI算法分析中说到的，这样的评估标准并不完备，经过我自己训练，测试得到的最好的一次成绩也仅仅是下落2000多砖块，消了1000层不到，所以还有很大的优化空间，如果有对这部分感兴趣的小伙伴可以查看上面算法分析时推荐的那篇文章。</p>
<p><img src="/img/tetris-end.png" alt="The End"></p>
<h2 id="声明"><a href="#声明" class="headerlink" title="声明:"></a>声明:</h2><p>作者 ： PrConstantin<br>来源 ： <a href="http://constantin.cc" target="_blank" rel="noopener">http://constantin.cc</a><br>链接 ： <a href="http://constantin.cc/2017/11/06/TetrisWithAI/" target="_blank" rel="noopener">http://constantin.cc/2017/11/06/TetrisWithAI/</a>  </p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/09/Postcss/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          使用Webpack配置CSS预编译器Less+后处理器Postcss的Autoprefixer功能
        
      </div>
    </a>
  
  
    <a href="/2018/05/09/Markdown/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">React之实用Markdown编辑器使用手册</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 Constantin
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"scale":0.6,"hHeadPos":1,"vHeadPos":1,"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-miku@1.0.5/assets/miku.model.json"},"display":{"superSample":2,"width":80,"height":170,"position":"left","hOffset":15,"vOffset":-65},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.2},"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/"});</script></body>
</html>